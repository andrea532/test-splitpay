<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSplit - Gestione Spese di Gruppo</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.5;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #2196F3;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
            flex: 1;
            text-align: center;
            margin: 0 16px;
        }

        .header-button {
            background-color: #1976D2;
            border: none;
            border-radius: 20px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .header-button:hover {
            background-color: #1565C0;
        }

        .content {
            flex: 1;
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .quick-action-button {
            background-color: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .quick-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .quick-action-icon {
            font-size: 24px;
        }

        .quick-action-text {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .group-card {
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .group-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .group-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .group-amount {
            font-size: 14px;
            color: #2196F3;
            font-weight: 600;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .section-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            font-style: italic;
        }

        .add-button {
            background-color: #4CAF50;
            border: none;
            border-radius: 20px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
        }

        .balance-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .balance-info h4 {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .balance-details {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .balance-amount {
            font-size: 16px;
            font-weight: bold;
        }

        .settlement-card {
            background-color: #E3F2FD;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #2196F3;
        }

        .settlement-text {
            font-size: 14px;
            color: #1976D2;
            text-align: center;
            font-weight: 500;
        }

        .expense-card {
            margin-bottom: 12px;
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .expense-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            flex: 1;
            margin-right: 8px;
        }

        .expense-amount {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
        }

        .expense-creator {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .expense-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .expense-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }

        .expense-shares {
            border-top: 1px solid #eee;
            padding-top: 8px;
        }

        .expense-shares-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .expense-share {
            font-size: 13px;
            color: #666;
            margin-bottom: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-subtext {
            font-size: 14px;
            color: #999;
            margin-bottom: 24px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-container {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            background-color: #f8f9fa;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .modal-button {
            background: none;
            border: none;
            color: #2196F3;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 8px;
        }

        .modal-cancel {
            color: #666;
        }

        .modal-content {
            padding: 16px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .input {
            width: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33,150,243,0.2);
        }

        .input-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .member-expense-input {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .member-label {
            flex: 1;
            font-size: 14px;
            color: #333;
            margin-right: 8px;
        }

        .amount-input {
            width: 80px;
            text-align: right;
            font-size: 16px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        .currency-label {
            font-size: 16px;
            color: #666;
            margin-left: 8px;
        }

        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .remove-button {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 20px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .total-section {
            background-color: #E3F2FD;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .total-label {
            font-size: 16px;
            font-weight: bold;
            color: #1976D2;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            background-color: #f0f8ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-card {
            background-color: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-logo {
            text-align: center;
            font-size: 32px;
            margin-bottom: 8px;
            color: #2196F3;
        }

        .auth-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
        }

        .submit-button {
            width: 100%;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 16px;
            transition: background-color 0.2s;
        }

        .submit-button:hover {
            background-color: #1976D2;
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .switch-container {
            text-align: center;
            color: #666;
        }

        .switch-button {
            color: #2196F3;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            border-left-color: #f44336;
        }

        .success-message {
            background-color: #e8f5e8;
            color: #2e7d32;
            border-left-color: #4caf50;
        }

        .info-message {
            background-color: #e3f2fd;
            color: #1976d2;
            border-left-color: #2196f3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2196f3;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px;
            }
            
            .content {
                padding: 12px;
            }
            
            .modal-container {
                margin: 10px;
            }

            .expense-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .expense-amount {
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configurazione Supabase
        const supabaseUrl = 'https://qgykqstpuwcagcgacyyi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWtxc3RwdXdjYWdjZ2FjeXlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1OTg1OTMsImV4cCI6MjA2NDE3NDU5M30.i6SWEdotKTAlYQRcbbtgq5usizA2JDk8vWQzG_cqOzQ';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Utility functions
        const generateInviteCode = () => {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        };

        const formatDate = (date) => {
            return new Date(date).toLocaleDateString('it-IT');
        };

        // Calcola regolamenti ottimali
        const calculateOptimalSettlements = (balances) => {
            const creditors = balances
                .filter(b => parseFloat(b.balance) > 0.01)
                .map(b => ({ ...b, balance: parseFloat(b.balance) }))
                .sort((a, b) => b.balance - a.balance);

            const debtors = balances
                .filter(b => parseFloat(b.balance) < -0.01)
                .map(b => ({ ...b, balance: Math.abs(parseFloat(b.balance)) }))
                .sort((a, b) => b.balance - a.balance);

            const settlements = [];
            let i = 0, j = 0;

            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];
                
                const transferAmount = Math.min(creditor.balance, debtor.balance);
                
                if (transferAmount > 0.01) {
                    settlements.push({
                        from: debtor.full_name || debtor.email,
                        to: creditor.full_name || creditor.email,
                        amount: transferAmount
                    });
                    
                    creditor.balance -= transferAmount;
                    debtor.balance -= transferAmount;
                }
                
                if (creditor.balance <= 0.01) i++;
                if (debtor.balance <= 0.01) j++;
            }

            return settlements;
        };

        // Auth Component
        const AuthScreen = ({ onAuthSuccess }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [isLoading, setIsLoading] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');

                try {
                    if (isLogin) {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email: email.trim().toLowerCase(),
                            password: password
                        });

                        if (error) throw error;
                        onAuthSuccess(data.user);
                    } else {
                        const { data, error } = await supabase.auth.signUp({
                            email: email.trim().toLowerCase(),
                            password: password,
                            options: {
                                data: { full_name: fullName.trim() }
                            }
                        });

                        if (error) throw error;
                        
                        if (data.user) {
                            onAuthSuccess(data.user);
                        }
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="auth-container">
                    <form className="auth-card" onSubmit={handleSubmit}>
                        <div className="auth-logo">üí∞ SmartSplit</div>
                        <h2 className="auth-title">
                            {isLogin ? 'Bentornato!' : 'Crea Account'}
                        </h2>
                        <p className="auth-subtitle">
                            {isLogin 
                                ? 'Accedi per gestire le tue spese' 
                                : 'Registrati per iniziare'
                            }
                        </p>

                        {error && (
                            <div className="message error-message">{error}</div>
                        )}

                        {!isLogin && (
                            <input
                                type="text"
                                className="input"
                                placeholder="Nome completo"
                                value={fullName}
                                onChange={(e) => setFullName(e.target.value)}
                                required
                            />
                        )}

                        <input
                            type="email"
                            className="input"
                            placeholder="Email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />

                        <input
                            type="password"
                            className="input"
                            placeholder="Password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                            minLength="6"
                        />

                        <button 
                            type="submit" 
                            className="submit-button" 
                            disabled={isLoading}
                        >
                            {isLoading ? 'Caricamento...' : (isLogin ? 'Accedi' : 'Registrati')}
                        </button>

                        <div className="switch-container">
                            {isLogin ? 'Non hai un account? ' : 'Hai gi√† un account? '}
                            <span 
                                className="switch-button"
                                onClick={() => {
                                    setIsLogin(!isLogin);
                                    setError('');
                                }}
                            >
                                {isLogin ? 'Registrati' : 'Accedi'}
                            </span>
                        </div>
                    </form>
                </div>
            );
        };

        // Group Details Component
        const GroupDetails = ({ group, onBack, onUpdate }) => {
            const [expenses, setExpenses] = useState([]);
            const [balances, setBalances] = useState([]);
            const [settlements, setSettlements] = useState([]);
            const [showAddExpense, setShowAddExpense] = useState(false);
            const [showMembers, setShowMembers] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                loadGroupData();
            }, [group.id]);

            const loadGroupData = async () => {
                try {
                    setIsLoading(true);

                    // Load expenses
                    const { data: expensesData, error: expensesError } = await supabase
                        .from('expenses')
                        .select(`
                            *,
                            created_by_profile:profiles!expenses_created_by_fkey(full_name, email),
                            expense_shares(
                                user_id,
                                amount_consumed,
                                profiles(full_name, email)
                            )
                        `)
                        .eq('group_id', group.id)
                        .order('created_at', { ascending: false });

                    if (expensesError) throw expensesError;
                    setExpenses(expensesData || []);

                    // Load balances
                    const { data: balancesData, error: balancesError } = await supabase
                        .from('user_group_balances')
                        .select('*')
                        .eq('group_id', group.id);

                    if (balancesError) throw balancesError;
                    setBalances(balancesData || []);
                    setSettlements(calculateOptimalSettlements(balancesData || []));

                } catch (error) {
                    console.error('Error loading group data:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            if (isLoading) {
                return (
                    <div className="loading">
                        <div className="loading-spinner"></div>
                        <div>Caricamento dati gruppo...</div>
                    </div>
                );
            }

            const totalAmount = expenses.reduce((sum, exp) => sum + parseFloat(exp.total_amount), 0);

            return (
                <div className="container">
                    <header className="header">
                        <button className="header-button" onClick={onBack}>
                            ‚Üê
                        </button>
                        <h1 className="header-title">{group.name}</h1>
                        <button className="header-button" onClick={() => setShowMembers(true)}>
                            üë•
                        </button>
                    </header>

                    <main className="content">
                        {/* Group Info */}
                        <div className="card">
                            <h3 className="group-name">{group.name}</h3>
                            {group.description && (
                                <p className="group-details">{group.description}</p>
                            )}
                            <div className="stats-grid">
                                <div className="stat-item">
                                    <div className="stat-value">{group.memberCount}</div>
                                    <div className="stat-label">Membri</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value">{expenses.length}</div>
                                    <div className="stat-label">Spese</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value">{totalAmount.toFixed(2)}‚Ç¨</div>
                                    <div className="stat-label">Totale</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value">{group.invite_code}</div>
                                    <div className="stat-label">Codice</div>
                                </div>
                            </div>
                        </div>

                        {/* Bilanci */}
                        {balances.length > 0 && (
                            <div className="section">
                                <h2 className="section-title">üí∞ Bilanci</h2>
                                <p className="section-subtitle">
                                    Chi deve ricevere (+) o dare (-) denaro
                                </p>
                                <div className="card">
                                    {balances.map((balance, index) => (
                                        <div key={index} className="balance-card">
                                            <div className="balance-info">
                                                <h4>{balance.full_name || balance.email}</h4>
                                                <div className="balance-details">
                                                    Pagato: {parseFloat(balance.total_paid).toFixed(2)}‚Ç¨ ‚Ä¢ 
                                                    Consumato: {parseFloat(balance.total_consumed).toFixed(2)}‚Ç¨
                                                </div>
                                            </div>
                                            <div className="balance-amount" style={{
                                                color: parseFloat(balance.balance) >= 0 ? '#4CAF50' : '#F44336'
                                            }}>
                                                {parseFloat(balance.balance) >= 0 ? '+' : ''}{parseFloat(balance.balance).toFixed(2)}‚Ç¨
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Regolamenti */}
                        {settlements.length > 0 && (
                            <div className="section">
                                <h2 className="section-title">üîÑ Regolamenti</h2>
                                <p className="section-subtitle">
                                    Pagamenti da effettuare per pareggiare i conti
                                </p>
                                {settlements.map((settlement, index) => (
                                    <div key={index} className="settlement-card">
                                        <div className="settlement-text">
                                            <strong>{settlement.from}</strong> deve <strong>{settlement.amount.toFixed(2)}‚Ç¨</strong> a <strong>{settlement.to}</strong>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Spese */}
                        <div className="section">
                            <div className="section-header">
                                <h2 className="section-title">üí≥ Spese</h2>
                                <button
                                    className="add-button"
                                    onClick={() => setShowAddExpense(true)}
                                >
                                    +
                                </button>
                            </div>

                            {expenses.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-icon">üßæ</div>
                                    <div className="empty-text">Nessuna spesa ancora</div>
                                    <div className="empty-subtext">
                                        Tocca + per aggiungere la prima spesa!
                                    </div>
                                </div>
                            ) : (
                                expenses.map((expense) => (
                                    <div key={expense.id} className="card expense-card">
                                        <div className="expense-header">
                                            <h4 className="expense-title">{expense.title}</h4>
                                            <div className="expense-amount">
                                                {parseFloat(expense.total_amount).toFixed(2)}‚Ç¨
                                            </div>
                                        </div>
                                        
                                        <div className="expense-creator">
                                            üí≥ Pagato da {expense.created_by_profile?.full_name || expense.created_by_profile?.email}
                                        </div>
                                        
                                        {expense.description && (
                                            <div className="expense-description">{expense.description}</div>
                                        )}
                                        
                                        {expense.location && (
                                            <div className="expense-description">üìç {expense.location}</div>
                                        )}
                                        
                                        <div className="expense-date">
                                            üìÖ {formatDate(expense.expense_date)}
                                        </div>

                                        {expense.expense_shares && expense.expense_shares.length > 0 && (
                                            <div className="expense-shares">
                                                <div className="expense-shares-title">Consumi:</div>
                                                {expense.expense_shares.map((share, index) => (
                                                    <div key={index} className="expense-share">
                                                        ‚Ä¢ {share.profiles?.full_name || share.profiles?.email}: {parseFloat(share.amount_consumed).toFixed(2)}‚Ç¨
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </main>

                    <AddExpenseModal
                        group={group}
                        isOpen={showAddExpense}
                        onClose={() => setShowAddExpense(false)}
                        onSuccess={() => {
                            setShowAddExpense(false);
                            loadGroupData();
                            onUpdate();
                        }}
                    />

                    <MembersModal
                        group={group}
                        isOpen={showMembers}
                        onClose={() => setShowMembers(false)}
                        onUpdate={() => {
                            loadGroupData();
                            onUpdate();
                        }}
                    />
                </div>
            );
        };

        // Add Expense Modal
        const AddExpenseModal = ({ group, isOpen, onClose, onSuccess }) => {
            const [user, setUser] = useState(null);
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                totalAmount: '',
                location: '',
                shares: {}
            });
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                supabase.auth.getUser().then(({ data: { user } }) => {
                    setUser(user);
                });
            }, []);

            useEffect(() => {
                if (isOpen && group.group_members) {
                    const initialShares = {};
                    group.group_members.forEach(member => {
                        initialShares[member.user_id] = '';
                    });
                    setFormData(prev => ({ ...prev, shares: initialShares }));
                }
            }, [isOpen, group]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');

                try {
                    if (!formData.title.trim()) {
                        throw new Error('Inserisci un titolo per la spesa');
                    }

                    const totalAmount = parseFloat(formData.totalAmount);
                    if (isNaN(totalAmount) || totalAmount <= 0) {
                        throw new Error('Inserisci un importo valido');
                    }

                    const hasShares = Object.values(formData.shares).some(amount => 
                        parseFloat(amount) > 0
                    );

                    if (!hasShares) {
                        throw new Error('Almeno una persona deve aver consumato qualcosa');
                    }

                    // Create expense
                    const { data: expense, error: expenseError } = await supabase
                        .from('expenses')
                        .insert([{
                            group_id: group.id,
                            created_by: user.id,
                            title: formData.title.trim(),
                            description: formData.description?.trim() || '',
                            total_amount: totalAmount,
                            location: formData.location?.trim() || '',
                            expense_date: new Date().toISOString().split('T')[0]
                        }])
                        .select()
                        .single();

                    if (expenseError) throw expenseError;

                    // Create shares
                    const shares = Object.entries(formData.shares)
                        .filter(([_, amount]) => parseFloat(amount) > 0)
                        .map(([userId, amount]) => ({
                            expense_id: expense.id,
                            user_id: userId,
                            amount_consumed: parseFloat(amount)
                        }));

                    if (shares.length > 0) {
                        const { error: sharesError } = await supabase
                            .from('expense_shares')
                            .insert(shares);

                        if (sharesError) throw sharesError;
                    }

                    setFormData({
                        title: '',
                        description: '',
                        totalAmount: '',
                        location: '',
                        shares: {}
                    });
                    onSuccess();

                } catch (error) {
                    setError(error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const calculateTotalShares = () => {
                return Object.values(formData.shares).reduce((sum, amount) => {
                    const num = parseFloat(amount);
                    return sum + (isNaN(num) ? 0 : num);
                }, 0);
            };

            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-container" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <button className="modal-button modal-cancel" onClick={onClose}>
                                Annulla
                            </button>
                            <h3 className="modal-title">Nuova Spesa</h3>
                            <button className="modal-button" onClick={handleSubmit} disabled={isLoading}>
                                {isLoading ? 'Salvataggio...' : 'Aggiungi'}
                            </button>
                        </div>
                        
                        <div className="modal-content">
                            {error && (
                                <div className="message error-message">{error}</div>
                            )}

                            <form onSubmit={handleSubmit}>
                                <label className="input-label">Titolo della spesa</label>
                                <input
                                    type="text"
                                    className="input"
                                    placeholder="es: Cena ristorante"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    maxLength="100"
                                    required
                                />

                                <label className="input-label">Descrizione (opzionale)</label>
                                <textarea
                                    className="input"
                                    placeholder="Dettagli aggiuntivi..."
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    maxLength="200"
                                    rows="3"
                                    style={{ resize: 'vertical', minHeight: '60px' }}
                                />

                                <label className="input-label">Importo totale pagato</label>
                                <input
                                    type="number"
                                    className="input"
                                    placeholder="0.00"
                                    value={formData.totalAmount}
                                    onChange={(e) => setFormData({...formData, totalAmount: e.target.value})}
                                    step="0.01"
                                    min="0"
                                    required
                                />

                                <label className="input-label">Luogo (opzionale)</label>
                                <input
                                    type="text"
                                    className="input"
                                    placeholder="es: Ristorante Da Mario"
                                    value={formData.location}
                                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                                    maxLength="100"
                                />

                                <label className="input-label">Quanto ha consumato ogni persona?</label>
                                {group.group_members?.map((member) => (
                                    <div key={member.user_id} className="member-expense-input">
                                        <span className="member-label">
                                            {member.profiles?.full_name || member.profiles?.email}
                                            {member.user_id === user?.id && ' (Tu)'}
                                        </span>
                                        <input
                                            type="number"
                                            className="amount-input"
                                            placeholder="0.00"
                                            value={formData.shares[member.user_id] || ''}
                                            onChange={(e) => setFormData({
                                                ...formData,
                                                shares: {
                                                    ...formData.shares,
                                                    [member.user_id]: e.target.value
                                                }
                                            })}
                                            step="0.01"
                                            min="0"
                                        />
                                        <span className="currency-label">‚Ç¨</span>
                                    </div>
                                ))}

                                <div className="total-section">
                                    <div className="total-label">
                                        Totale consumato: {calculateTotalShares().toFixed(2)}‚Ç¨
                                    </div>
                                    <div style={{ fontSize: '14px', color: '#666', marginTop: '4px' }}>
                                        Importo pagato: {parseFloat(formData.totalAmount || 0).toFixed(2)}‚Ç¨
                                    </div>
                                </div>

                                <div className="help-text">
                                    üí° <strong>Ricorda:</strong><br/>
                                    ‚Ä¢ Solo tu puoi aggiungere le TUE spese<br/>
                                    ‚Ä¢ Inserisci l'importo che HAI PAGATO<br/>
                                    ‚Ä¢ Indica quanto ha consumato ogni persona<br/>
                                    ‚Ä¢ I calcoli avvengono automaticamente!
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // Members Modal
        const MembersModal = ({ group, isOpen, onClose, onUpdate }) => {
            const [user, setUser] = useState(null);
            const [newMemberEmail, setNewMemberEmail] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => {
                supabase.auth.getUser().then(({ data: { user } }) => {
                    setUser(user);
                });
            }, []);

            const handleAddMember = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                setSuccess('');

                try {
                    if (!newMemberEmail.trim()) {
                        throw new Error('Inserisci un\'email');
                    }

                    // Find user by email
                    const { data: userData, error: userError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('email', newMemberEmail.trim().toLowerCase())
                        .single();

                    if (userError || !userData) {
                        throw new Error('Utente non trovato. Deve prima registrarsi su SmartSplit.');
                    }

                    // Check if already member
                    const { data: existingMember } = await supabase
                        .from('group_members')
                        .select('*')
                        .eq('group_id', group.id)
                        .eq('user_id', userData.id)
                        .single();

                    if (existingMember) {
                        throw new Error('Questo utente √® gi√† membro del gruppo');
                    }

                    // Add member
                    const { error: memberError } = await supabase
                        .from('group_members')
                        .insert([{
                            group_id: group.id,
                            user_id: userData.id,
                            role: 'member'
                        }]);

                    if (memberError) throw memberError;

                    setSuccess(`${userData.full_name || userData.email} aggiunto al gruppo!`);
                    setNewMemberEmail('');
                    onUpdate();

                } catch (error) {
                    setError(error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleRemoveMember = async (memberId) => {
                if (!confirm('Sei sicuro di voler rimuovere questo membro?')) return;

                try {
                    const { error } = await supabase
                        .from('group_members')
                        .delete()
                        .eq('group_id', group.id)
                        .eq('user_id', memberId);

                    if (error) throw error;

                    setSuccess('Membro rimosso dal gruppo');
                    onUpdate();

                } catch (error) {
                    setError(error.message);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-container" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <button className="modal-button modal-cancel" onClick={onClose}>
                                Chiudi
                            </button>
                            <h3 className="modal-title">Gestisci Membri</h3>
                            <div></div>
                        </div>
                        
                        <div className="modal-content">
                            {error && (
                                <div className="message error-message">{error}</div>
                            )}

                            {success && (
                                <div className="message success-message">{success}</div>
                            )}

                            <form onSubmit={handleAddMember}>
                                <label className="input-label">Aggiungi membro tramite email</label>
                                <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                                    <input
                                        type="email"
                                        className="input"
                                        placeholder="email@esempio.com"
                                        value={newMemberEmail}
                                        onChange={(e) => setNewMemberEmail(e.target.value)}
                                        style={{ marginBottom: 0, flex: 1 }}
                                        required
                                    />
                                    <button 
                                        type="submit" 
                                        className="submit-button" 
                                        disabled={isLoading}
                                        style={{ marginBottom: 0, width: 'auto', padding: '12px 16px' }}
                                    >
                                        {isLoading ? '...' : 'Aggiungi'}
                                    </button>
                                </div>
                            </form>

                            <label className="input-label">
                                Membri del gruppo ({group.group_members?.length || 0})
                            </label>

                            {!group.group_members || group.group_members.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-icon">üë•</div>
                                    <div className="empty-text">Nessun membro</div>
                                </div>
                            ) : (
                                group.group_members.map((member) => (
                                    <div key={member.user_id} className="member-item">
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>
                                                {member.profiles?.full_name || member.profiles?.email}
                                                {member.user_id === user?.id && ' (Tu)'}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666' }}>
                                                {member.role === 'admin' ? 'üëë Admin' : 'üë§ Membro'}
                                            </div>
                                        </div>
                                        {member.user_id !== user?.id && member.role !== 'admin' && (
                                            <button
                                                className="remove-button"
                                                onClick={() => handleRemoveMember(member.user_id)}
                                            >
                                                √ó
                                            </button>
                                        )}
                                    </div>
                                ))
                            )}

                            <div className="help-text">
                                üí° <strong>Per aggiungere membri:</strong><br/>
                                ‚Ä¢ I membri devono prima registrarsi su SmartSplit<br/>
                                ‚Ä¢ Inserisci la loro email esatta<br/>
                                ‚Ä¢ Oppure condividi il codice invito: <strong>{group.invite_code}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Create Group Modal
        const CreateGroupModal = ({ isOpen, onClose, onCreateGroup }) => {
            const [groupName, setGroupName] = useState('');
            const [description, setDescription] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (groupName.trim()) {
                    onCreateGroup(groupName.trim(), description.trim());
                    setGroupName('');
                    setDescription('');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-container" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <button className="modal-button modal-cancel" onClick={onClose}>
                                Annulla
                            </button>
                            <h3 className="modal-title">Nuovo Gruppo</h3>
                            <button className="modal-button" onClick={handleSubmit}>
                                Crea
                            </button>
                        </div>
                        <form className="modal-content" onSubmit={handleSubmit}>
                            <input
                                type="text"
                                className="input"
                                placeholder="Nome del gruppo"
                                value={groupName}
                                onChange={(e) => setGroupName(e.target.value)}
                                maxLength="50"
                                required
                                autoFocus
                            />
                            <textarea
                                className="input"
                                placeholder="Descrizione (opzionale)"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                maxLength="200"
                                rows="3"
                                style={{ resize: 'vertical', minHeight: '80px' }}
                            />
                        </form>
                    </div>
                </div>
            );
        };

        // Join Group Modal
        const JoinGroupModal = ({ isOpen, onClose, onJoinGroup }) => {
            const [inviteCode, setInviteCode] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (inviteCode.trim()) {
                    onJoinGroup(inviteCode.trim().toUpperCase());
                    setInviteCode('');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-container" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <button className="modal-button modal-cancel" onClick={onClose}>
                                Annulla
                            </button>
                            <h3 className="modal-title">Unisciti a Gruppo</h3>
                            <button className="modal-button" onClick={handleSubmit}>
                                Unisciti
                            </button>
                        </div>
                        <form className="modal-content" onSubmit={handleSubmit}>
                            <input
                                type="text"
                                className="input"
                                placeholder="Codice invito"
                                value={inviteCode}
                                onChange={(e) => setInviteCode(e.target.value.toUpperCase())}
                                maxLength="10"
                                required
                                autoFocus
                            />
                            <p style={{ fontSize: '14px', color: '#666', textAlign: 'center' }}>
                                üí° Chiedi il codice invito al creatore del gruppo
                            </p>
                        </form>
                    </div>
                </div>
            );
        };

        // Main App Component
        const SmartSplitApp = () => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [groups, setGroups] = useState([]);
            const [activeGroup, setActiveGroup] = useState(null);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showJoinModal, setShowJoinModal] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            // Initialize auth
            useEffect(() => {
                // Check current session
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user || null);
                    setIsLoading(false);
                });

                // Listen for auth changes
                const { data: { subscription } } = supabase.auth.onAuthStateChange(
                    async (event, session) => {
                        setUser(session?.user || null);
                        if (session?.user) {
                            loadGroups();
                        } else {
                            setGroups([]);
                            setActiveGroup(null);
                        }
                    }
                );

                return () => subscription.unsubscribe();
            }, []);

            // Load groups when user changes
            useEffect(() => {
                if (user) {
                    loadGroups();
                }
            }, [user]);

            const loadGroups = async () => {
                try {
                    // Get user's group memberships
                    const { data: memberships, error: memberError } = await supabase
                        .from('group_members')
                        .select('group_id')
                        .eq('user_id', user.id);

                    if (memberError) throw memberError;

                    if (memberships.length === 0) {
                        setGroups([]);
                        return;
                    }

                    const groupIds = memberships.map(m => m.group_id);

                    // Get groups details
                    const { data: groupsData, error: groupsError } = await supabase
                        .from('groups')
                        .select(`
                            *,
                            group_members(
                                user_id,
                                role,
                                profiles(full_name, email)
                            ),
                            expenses(total_amount)
                        `)
                        .in('id', groupIds)
                        .order('created_at', { ascending: false });

                    if (groupsError) throw groupsError;

                    // Calculate stats
                    const groupsWithStats = groupsData.map(group => ({
                        ...group,
                        memberCount: group.group_members?.length || 0,
                        expenseCount: group.expenses?.length || 0,
                        totalAmount: group.expenses?.reduce((sum, exp) => sum + parseFloat(exp.total_amount), 0) || 0
                    }));

                    setGroups(groupsWithStats);
                } catch (error) {
                    console.error('Error loading groups:', error);
                    setError('Errore nel caricamento gruppi');
                }
            };

            const createGroup = async (name, description) => {
                try {
                    setError('');
                    
                    const { data: group, error: groupError } = await supabase
                        .from('groups')
                        .insert([{
                            name: name,
                            description: description,
                            created_by: user.id,
                            invite_code: generateInviteCode()
                        }])
                        .select()
                        .single();

                    if (groupError) throw groupError;

                    // Add user as admin
                    const { error: memberError } = await supabase
                        .from('group_members')
                        .insert([{
                            group_id: group.id,
                            user_id: user.id,
                            role: 'admin'
                        }]);

                    if (memberError) throw memberError;

                    setSuccess('Gruppo creato con successo!');
                    setShowCreateModal(false);
                    loadGroups();

                    setTimeout(() => setSuccess(''), 3000);
                } catch (error) {
                    console.error('Error creating group:', error);
                    setError('Errore nella creazione del gruppo: ' + error.message);
                }
            };

            const joinGroup = async (inviteCode) => {
                try {
                    setError('');

                    // Find group by invite code
                    const { data: group, error: groupError } = await supabase
                        .from('groups')
                        .select('*')
                        .eq('invite_code', inviteCode)
                        .single();

                    if (groupError || !group) {
                        throw new Error('Codice invito non valido');
                    }

                    // Check if already member
                    const { data: existingMember } = await supabase
                        .from('group_members')
                        .select('*')
                        .eq('group_id', group.id)
                        .eq('user_id', user.id)
                        .single();

                    if (existingMember) {
                        throw new Error('Sei gi√† membro di questo gruppo');
                    }

                    // Join group
                    const { error: joinError } = await supabase
                        .from('group_members')
                        .insert([{
                            group_id: group.id,
                            user_id: user.id,
                            role: 'member'
                        }]);

                    if (joinError) throw joinError;

                    setSuccess(`Ti sei unito al gruppo "${group.name}"!`);
                    setShowJoinModal(false);
                    loadGroups();

                    setTimeout(() => setSuccess(''), 3000);
                } catch (error) {
                    console.error('Error joining group:', error);
                    setError('Errore: ' + error.message);
                }
            };

            const handleLogout = async () => {
                if (confirm('Sei sicuro di voler uscire?')) {
                    await supabase.auth.signOut();
                    setGroups([]);
                    setActiveGroup(null);
                }
            };

            const handleGroupSelect = async (group) => {
                // Load full group details
                const { data: fullGroup, error } = await supabase
                    .from('groups')
                    .select(`
                        *,
                        group_members(
                            user_id,
                            role,
                            profiles(full_name, email)
                        )
                    `)
                    .eq('id', group.id)
                    .single();

                if (error) {
                    setError('Errore nel caricamento del gruppo');
                    return;
                }

                setActiveGroup({
                    ...fullGroup,
                    memberCount: fullGroup.group_members?.length || 0
                });
            };

            if (isLoading) {
                return (
                    <div className="loading">
                        <div className="loading-spinner"></div>
                        <div>Caricamento...</div>
                    </div>
                );
            }

            if (!user) {
                return <AuthScreen onAuthSuccess={setUser} />;
            }

            if (activeGroup) {
                return (
                    <GroupDetails
                        group={activeGroup}
                        onBack={() => setActiveGroup(null)}
                        onUpdate={loadGroups}
                    />
                );
            }

            return (
                <div className="container">
                    <header className="header">
                        <button className="header-button" onClick={handleLogout}>
                            üö™
                        </button>
                        <h1 className="header-title">I tuoi gruppi</h1>
                        <button className="header-button" onClick={() => setShowCreateModal(true)}>
                            +
                        </button>
                    </header>

                    <main className="content">
                        {error && (
                            <div className="message error-message">{error}</div>
                        )}

                        {success && (
                            <div className="message success-message">{success}</div>
                        )}

                        <div className="quick-actions">
                            <button 
                                className="quick-action-button"
                                onClick={() => setShowCreateModal(true)}
                            >
                                <div className="quick-action-icon">‚ûï</div>
                                <div className="quick-action-text">Crea Gruppo</div>
                            </button>
                            
                            <button 
                                className="quick-action-button"
                                onClick={() => setShowJoinModal(true)}
                            >
                                <div className="quick-action-icon">üîó</div>
                                <div className="quick-action-text">Unisciti</div>
                            </button>
                        </div>

                        {groups.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-icon">üë•</div>
                                <div className="empty-text">Nessun gruppo ancora</div>
                                <div className="empty-subtext">
                                    Crea un gruppo o unisciti a uno esistente per iniziare!
                                </div>
                                <button 
                                    className="submit-button"
                                    onClick={() => setShowCreateModal(true)}
                                    style={{ maxWidth: '300px', margin: '0 auto' }}
                                >
                                    Crea il tuo primo gruppo
                                </button>
                            </div>
                        ) : (
                            <div>
                                {groups.map(group => (
                                    <div 
                                        key={group.id} 
                                        className="card group-card"
                                        onClick={() => handleGroupSelect(group)}
                                    >
                                        <div className="group-info">
                                            <h3 className="group-name">{group.name}</h3>
                                            <div className="group-details">
                                                {group.memberCount} membri ‚Ä¢ {group.expenseCount} spese
                                            </div>
                                            {group.totalAmount > 0 && (
                                                <div className="group-amount">
                                                    Totale: {group.totalAmount.toFixed(2)}‚Ç¨
                                                </div>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '20px', color: '#666' }}>‚Üí</div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <CreateGroupModal
                        isOpen={showCreateModal}
                        onClose={() => setShowCreateModal(false)}
                        onCreateGroup={createGroup}
                    />

                    <JoinGroupModal
                        isOpen={showJoinModal}
                        onClose={() => setShowJoinModal(false)}
                        onJoinGroup={joinGroup}
                    />
                </div>
            );
        };

        // Render app
        ReactDOM.render(<SmartSplitApp />, document.getElementById('root'));
    </script>
</body>
</html>
